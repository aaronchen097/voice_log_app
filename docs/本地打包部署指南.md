# 语音智能日志系统 - 本地打包部署指南

## 项目概述

语音智能日志系统是一个基于阿里云听悟API的智能语音转录和摘要生成系统，支持音频文件上传、实时语音转录、智能摘要生成和日志查询功能。

## 最新修复和优化 (v1.3.0)

### 🔧 修复的问题

1.  **API兼容性问题**
    *   将 `openai` 库替换为 `dashscope` 库，解决了 `proxies` 参数不兼容的问题。
    *   更新了 `get_summary` 函数，使用 `dashscope` 的 `Generation.call` 方法，并传入 `messages` 格式的输入。

2.  **SSL连接错误**
    *   在 `get_summary` 函数中添加了重试机制，以处理临时的SSL连接错误。
    *   引入了 `HTTPStatus` 来检查API调用的返回状态。

### ✨ 新增功能

1.  **工程化部署脚本**
    *   添加了 `local_build.ps1` (Windows) 和 `local_build.sh` (Linux/Mac) 脚本，用于在本地构建和打包Docker镜像。
    *   添加了 `server_deploy.sh` 脚本，用于在服务器上快速部署应用。

## 系统要求

*   Docker 和 Docker Compose
*   阿里云账号和相关服务配置
*   网络连接（用于访问阿里云API）

## 环境配置

### 1. 环境变量设置

创建 `.env` 文件并配置以下变量：

```env
# 阿里云访问密钥
ALIBABA_CLOUD_ACCESS_KEY_ID=your_access_key_id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your_access_key_secret

# OSS配置
OSS_ENDPOINT=your_oss_endpoint
OSS_BUCKET_NAME=your_bucket_name

# 通义千问API配置
DASHSCOPE_API_KEY=your_dashscope_api_key
```

### 2. 阿里云服务配置

确保已开通以下服务：
*   通义听悟（语音转录）
*   对象存储OSS（文件存储）
*   通义千问（智能摘要）

## 部署步骤

### 1. 本地打包

在本地环境中，执行以下命令来构建Docker镜像并将其打包为 `.tar` 文件。

#### Windows 用户

```powershell
.\local_build.ps1 -Version v1.3.0
```

#### Linux/Mac 用户

```bash
./local_build.sh v1.3.0
```

执行成功后，会在项目根目录下生成 `voice-log-app-v1.3.0.tar` 文件。

### 2. 服务器部署

将打包好的 `voice-log-app-v1.3.0.tar` 文件和 `server_deploy.sh`、`docker-compose.yml`、`.env` 文件传输到服务器的同个目录下。

在服务器上执行以下命令：

```bash
./server_deploy.sh voice-log-app-v1.3.0.tar
```

脚本会自动加载Docker镜像，停止旧容器，并启动新容器。

### 3. 访问应用

打开浏览器访问：`http://<your-server-ip>:31101`

## 功能使用说明

### 1. 文件上传转录
*   支持格式：MP3, WAV, M4A, AAC
*   最大文件大小：500MB
*   实时显示处理进度和等待时间
*   自动生成转录文本

### 2. 智能摘要生成
*   支持多种摘要类型：日报、周报、会议纪要等
*   基于通义千问大模型
*   一键生成结构化摘要

### 3. 日志查询
*   智能语义搜索
*   历史记录管理
*   最新摘要查看

## 故障排除

### 常见问题

1.  **文件上传失败**
    *   检查文件格式和大小限制
    *   确认网络连接正常
    *   查看容器日志：`docker compose logs`

2.  **转录任务超时**
    *   大文件处理时间较长，请耐心等待
    *   检查阿里云API配额和权限
    *   查看实时等待时长显示

3.  **API调用失败**
    *   验证环境变量配置
    *   检查阿里云服务状态
    *   确认API密钥权限

### 日志查看

```bash
# 查看容器日志
docker compose logs -f

# 查看特定服务日志
docker compose logs voice-log-app
```

## 开发和调试

### 本地开发环境

1.  **安装依赖**
```bash
pip install -r requirements.txt
```

2.  **启动开发服务器**
```bash
uvicorn main:app --reload --host 0.0.0.0 --port 31101
```

### 代码结构

```
├── main.py              # FastAPI主应用
├── utils.py             # 核心业务逻辑
├── frontend/            # 前端文件
│   ├── index.html       # 主页面
│   ├── script.js        # JavaScript逻辑
│   └── styles.css       # 样式文件
├── requirements.txt     # Python依赖
├── Dockerfile          # Docker构建文件
├── docker-compose.yml  # Docker编排文件
├── local_build.ps1      # Windows打包脚本
├── local_build.sh       # Linux/Mac打包脚本
├── server_deploy.sh     # 服务器部署脚本
└── .env               # 环境变量配置
```

## 版本历史

### v1.3.0 (当前版本)
*   修复API兼容性和SSL连接错误
*   添加工程化部署脚本

### v1.2.0
*   添加文件上传功能
*   优化Docker部署流程
*   改进前端用户界面

### v1.1.0
*   基础语音转录功能
*   智能摘要生成
*   日志查询系统

## 技术支持

如遇到问题，请：
1.  查看本文档的故障排除部分
2.  检查容器日志获取详细错误信息
3.  确认环境配置和网络连接
4.  验证阿里云服务状态和API权限

---

**注意**：请确保妥善保管API密钥，不要将包含敏感信息的 `.env` 文件提交到版本控制系统。